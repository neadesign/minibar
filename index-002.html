<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minibar Neaspace Auto-Check-out</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #fcfcfc;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    /* Stili CSS restanti come nel tuo codice */
  </style>
</head>
<body>
  <div id="toastOverlay">Stai per essere inoltrato alla pagina di pagamento...</div>

  <header>
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/favicon.png" alt="Nea logo">
    <h1>Minibar Naespace Auto Check-out</h1>
  </header>

  <div class="lang-select">
    <span onclick="setLang('IT')" style="cursor:pointer; font-size: 18px; margin: 0 10px;">ðŸ‡®ðŸ‡¹ Italiano</span>
    <span onclick="setLang('EN')" style="cursor:pointer; font-size: 18px; margin: 0 10px;">ðŸ‡¬ðŸ‡§ English</span>
    <span onclick="setLang('FR')" style="cursor:pointer; font-size: 18px; margin: 0 10px;">ðŸ‡«ðŸ‡· FranÃ§ais</span>
    <span onclick="setLang('ES')" style="cursor:pointer; font-size: 18px; margin: 0 10px;">ðŸ‡ªðŸ‡¸ EspaÃ±ol</span>
  </div>
  <input type="hidden" id="lang" value="IT">

  <div id="products" class="product-list"></div>

  <div class="cart">
    <h2 id="cart-title">Il tuo carrello</h2>
    <table id="cart-table">
      <thead><tr><th id="th-product">Prodotto</th><th id="th-qty">QuantitÃ </th><th id="th-price">Prezzo</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <h3 id="total">Totale: â‚¬0.00</h3>
  </div>

  <div class="checkout">
    <button id="checkout-button" onclick="sendOrder()">Invia ordine / Paga</button>
  </div>
  <div class="stripe-note">
    <img src="https://stripe.com/img/v3/home/twitter.png" alt="Stripe logo" style="height: 20px; vertical-align: middle; margin-right: 8px;">
    <span>Payment secured by Stripe</span>
  </div>

  <script>
    const sheetURL = 'https://raw.githubusercontent.com/neadesign/minibar/main/listino.csv';
    let cart = [];

    function loadProducts() {
      const lang = document.getElementById('lang').value;
      document.getElementById('products').innerHTML = '';
      Papa.parse(sheetURL, {
        download: true,
        header: true,
        complete: function(results) {
          results.data.forEach(item => {
            const langMap = {
              IT: "Prodotto (IT)",
              EN: "Product (EN)",
              FR: "Produit (FR)",
              ES: "Producto (ES)"
            };
            const nameKey = langMap[lang];
            const name = item[nameKey]?.trim();
            const price = parseFloat(item["Prezzo"]);
            if (!name || isNaN(price)) return;

            const productDiv = document.createElement('div');
            productDiv.className = 'product';
            productDiv.innerHTML = `
              <h3>${name}</h3>
              <p>â‚¬${price.toFixed(2)}</p>
              <input type="number" min="1" value="1" />
              <button onclick="addToCart('${name}', ${price}, this)">Aggiungi</button>
            `;
            document.getElementById('products').appendChild(productDiv);
          });
          updateLabels(lang);
        }
      });
    }

    function updateCart() {
      const tbody = document.querySelector('#cart-table tbody');
      tbody.innerHTML = '';
      let total = 0;
      cart.forEach((item, index) => {
        total += item.price * item.qty;
        const row = `<tr>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>â‚¬${(item.price * item.qty).toFixed(2)}</td>
          <td><button class='remove-btn' onclick='removeFromCart(${index})'>âœ–</button></td>
        </tr>`;
        tbody.innerHTML += row;
      });

      const lang = document.getElementById('lang').value;
      document.getElementById('total').innerText = `Totale: â‚¬${total.toFixed(2)}`;
    }

    function addToCart(name, price, btn) {
      const qty = parseInt(btn.previousElementSibling.value);
      cart.push({ name, price, qty });
      updateCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCart();
    }

   async function sendOrder() {
  const button = document.getElementById('checkout-button');
  button.disabled = true;

  const lang = document.getElementById('lang').value;
  const orderDetails = cart.map(item => `- ${item.name}: ${item.qty} Ã— â‚¬${item.price.toFixed(2)} = â‚¬${(item.qty * item.price).toFixed(2)}`).join('\n');
  let total = cart.reduce((sum, item) => sum + item.price * item.qty, 0).toFixed(2);

  if (total <= 0) {
    showToast(getLabel('empty', lang), 4000);
    button.disabled = false;
    return;
  }

  // Se il totale Ã¨ inferiore a 5â‚¬, invia l'ordine al backend e reindirizza
  if (total < 5) {
    showToast(getLabel('smallgift', lang), 4000);
    button.disabled = false;

    // Prepara il payload con il metadata source
    const payload = {
      type: 'minibar',
      source: 'minibar', // Questo Ã¨ il metadata che inviamo
      cart,
      orderDetails,
      total,
      orderDetailsShort: orderDetails, // Riassunto dell'ordine (opzionale)
      orderDetailsLong: orderDetails,  // Dettagli completi dell'ordine
    };

    try {
      const response = await fetch('https://minibar.onrender.com/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();

      if (result && result.redirect) {
        // Se il backend restituisce un redirect (per esempio "thank-you.html")
        window.location.href = result.redirect;  // Reindirizza alla pagina regalo
      }
    } catch (error) {
      console.error('Errore durante l\'invio dell\'ordine:', error);
      button.disabled = false;
    }
    return;
  }

  // Se il totale Ã¨ maggiore di 5â‚¬, continua con il flusso Stripe
  const payload = {
    type: 'minibar',
    source: 'minibar',
    cart,
    orderDetails,
    total,
    orderDetailsShort: orderDetails,
    orderDetailsLong: orderDetails,
    delivery_date: '2025-12-31',
    phone: '-'
  };

  try {
    const response = await fetch('https://minibar.onrender.com/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();

    if (result && result.redirect) {
      // Se il backend restituisce un redirect (per esempio, Stripe)
      window.location.href = result.redirect;
    } else if (result && result.url) {
      showToast(getLabel('popup', lang), 7000);

      // Riabilita il pulsante PRIMA del redirect
      button.disabled = false;
      setTimeout(() => {
        window.location.href = result.url;
      }, 7000);
    }
  } catch (error) {
    console.error('Errore durante il checkout:', error);
    button.disabled = false;
    alert("Errore durante il checkout: " + error.message);
  }
}

    function showToast(message, duration = 7000) {
      const toast = document.getElementById('toastOverlay');
      toast.innerText = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }

    function setLang(code) {
      document.getElementById('lang').value = code;
      loadProducts();
    }

    window.onload = loadProducts;
  </script>
</body>
</html>
